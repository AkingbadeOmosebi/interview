# .github/workflows/terraform-deploy-eks-tfsec.yaml
# GitHub Actions workflow to deploy EKS infrastructure
# GitHub Actions executes terraform plan/apply (not Terraform Cloud)
# Terraform Cloud is used ONLY for remote state storage
# Uses OIDC for secure AWS authentication (no hardcoded keys!)
# Includes TFSec security scanning and Infracost

name: 'Terraform EKS Deployment'

on:
  push:
    branches:
      - main
    paths:
      - 'infrastructure/**.tf'
      - 'infrastructure/**.tfvars'
      - '.github/workflows/terraform-deploy-eks-tfsec.yaml'
  pull_request:
    branches:
      - main
    paths:
      - 'infrastructure/**.tf'
      - 'infrastructure/**.tfvars'
  workflow_dispatch:

concurrency:
  group: terraform-${{ github.ref }}
  cancel-in-progress: false

defaults:
  run:
    working-directory: ./infrastructure

jobs:
  terraform:
    name: 'Terraform Security & Deployment'
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read
      pull-requests: write

    steps:
      
      # STEP 1: Checkout Code
      
      - name: Checkout Code
        uses: actions/checkout@v4

      
      # STEP 2-6: TFSec Security Scanning      
      
      - name: Run TFSec Security Scanner
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: ./infrastructure
          soft_fail: true
          format: lovely
          additional_args: --minimum-severity MEDIUM
        continue-on-error: true

      - name: Install TFSec Binary
        run: |
          echo " Installing TFSec..."
          curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash
          tfsec --version
          echo " TFSec installed successfully"

      - name: Generate TFSec HTML Report
        run: |
          echo " Generating TFSec HTML report..."
          tfsec . --format html --out tfsec-report.html --minimum-severity LOW || true
          
          if [ -f tfsec-report.html ]; then
            echo "TFSec HTML report generated successfully"
            ls -lh tfsec-report.html
          else
            echo " TFSec HTML report not generated"
          fi

      - name: Upload TFSec HTML Report
        uses: actions/upload-artifact@v4
        with:
          name: tfsec-security-report-${{ github.run_number }}
          path: infrastructure/tfsec-report.html
          retention-days: 30
        continue-on-error: true

      - name: Generate TFSec Summary for PR
        if: github.event_name == 'pull_request'
        id: tfsec-summary
        run: |
          echo " Generating TFSec markdown summary..."
          tfsec . --format markdown --minimum-severity MEDIUM > tfsec-summary.md || true
          
          if [ -f tfsec-summary.md ] && [ -s tfsec-summary.md ]; then
            echo " TFSec summary generated"
            echo "TFSEC_SUMMARY<<EOF" >> $GITHUB_OUTPUT
            cat tfsec-summary.md >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "HAS_FINDINGS=true" >> $GITHUB_OUTPUT
          else
            echo " No TFSec findings to report"
            echo "HAS_FINDINGS=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment TFSec Results on PR
        if: github.event_name == 'pull_request' && steps.tfsec-summary.outputs.HAS_FINDINGS == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### TFSec Security Scan Results
            
            <details><summary>Show Security Findings</summary>
            
            ${{ steps.tfsec-summary.outputs.TFSEC_SUMMARY }}
            
            </details>
            
            Full HTML report available in workflow artifacts
            
            *Scanned by: @${{ github.actor }}*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

      
      # STEP 7-8: AWS Authentication via OIDC   
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: eu-central-1
          role-session-name: GitHubActions-TerraformDeploy

      - name: Verify AWS Identity
        run: |
          echo " Verifying AWS credentials..."
          aws sts get-caller-identity
          echo " AWS authentication successful"

      
      # STEP 9-12: Terraform Setup & Validation      
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.0
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Terraform Init
        id: init
        run: |
          echo " Initializing Terraform..."
          terraform init
          echo " Terraform initialized"

      - name: Terraform Validate
        run: |
          echo " Validating Terraform configuration..."
          terraform validate -no-color
          echo " Terraform validation passed"

      - name: Terraform Format Check
        run: |
          echo " Checking Terraform formatting..."
          terraform fmt -check -recursive || echo "‚ö†Ô∏è Formatting issues found"
        continue-on-error: true

      - name: Terraform Format (Auto-fix)
        if: failure()
        run: |
          echo " Auto-fixing Terraform formatting..."
          terraform fmt -recursive
          echo " Formatting applied"
        continue-on-error: true

      
      # STEP 13-16: Infracost Cost Estimation      
      
      - name: Setup Infracost
        uses: infracost/actions/setup@v3
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}

      - name: Generate Infracost JSON
        run: |
          echo " Generating Infracost estimate..."
          infracost breakdown \
            --path . \
            --format json \
            --out-file infracost.json
          
          echo " Infracost estimate generated"
          
          # Show summary in logs
          echo ""

          infracost breakdown --path . --format table


      - name: Post Infracost Comment on PR
        if: github.event_name == 'pull_request'
        uses: infracost/actions/comment@v2
        with:
          path: infracost.json
          behavior: update

      - name: Upload Infracost Report
        uses: actions/upload-artifact@v4
        with:
          name: infracost-report-${{ github.run_number }}
          path: infrastructure/infracost.json
          retention-days: 30

      
      # STEP 17-18: Terraform Plan (GitHub Actions Executes This)      
      
      - name: Terraform Plan
        id: plan
        run: |
          echo " Planning Terraform changes..."
          echo ""
          terraform plan -no-color -out=tfplan
          echo ""
          echo " Terraform plan completed"
        continue-on-error: false

      - name: Save Terraform Plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ github.run_number }}
          path: infrastructure/tfplan
          retention-days: 5

      - name: Comment Terraform Plan on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### üìã Terraform Plan
            
            <details><summary>Show Plan Output</summary>
            
            \`\`\`terraform
            Plan output available in workflow logs
            \`\`\`
            
            </details>
            
            üí° **Review the plan above before merging**
            
            *Planned by: @${{ github.actor }}*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

      
      # STEP 19: Terraform Apply (GitHub Actions Executes This)
      # Only runs on main branch pushes (not PRs)      
      
      - name: Terraform Apply
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          echo " Applying Terraform changes..."
          echo ""
          echo "  DEPLOYING TO AWS..."
          echo ""
          terraform apply -auto-approve tfplan
          echo ""
          echo " Terraform apply completed successfully"

      
      # STEP 20: Display Outputs      
      
      - name: Display Outputs
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          echo ""
          echo " DEPLOYMENT COMPLETE!"
          echo ""
          echo " EKS Cluster Information:"
          echo ""
          echo "  Cluster Name: $(terraform output -raw cluster_name)"
          echo "  Cluster Endpoint: $(terraform output -raw cluster_endpoint)"
          echo "  Region: eu-central-1"
          echo ""
          echo " Configure kubectl:"
          echo ""
          terraform output -raw kubeconfig_cmd
          echo ""
          echo ""
