# Operation Sanity Debug!!!
# NOTE TO MY SELF: (I'm Entering Forensic Mode to Get to the root cause of this specific pipeline misbehaving is.)

name: ci-docker-build-and-push-trivy-semantic-release

on:
  workflow_dispatch:
  
  workflow_run:
    workflows: ["Snyk-SCA"]
    types: [completed]
    # Temporarily removed branches: [main]

permissions:
  contents: write
  packages: write
  issues: write
  pull-requests: write
  id-token: write

jobs:
  debug:
    runs-on: ubuntu-latest
    # REMOVED the if condition here 
    steps:
      - name: Dump workflow_run context
        run: |
          echo "ðŸ”¥ DOCKER WORKFLOW WAS TRIGGERED! ðŸ”¥"
          echo "Event name: ${{ github.event_name }}"
          echo "Workflow run conclusion: ${{ github.event.workflow_run.conclusion }}"
          echo "Workflow run name: ${{ github.event.workflow_run.name }}"
          echo "Workflow run status: ${{ github.event.workflow_run.status }}"
          echo "Workflow run event: ${{ github.event.workflow_run.event }}"
          echo "Head branch: ${{ github.event.workflow_run.head_branch }}"
          echo "Full context:"
          echo '${{ toJSON(github.event.workflow_run) }}'

  build_scan_release_push:
    needs: debug  
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: interview-app
    steps:
      # 1ï¸âƒ£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # Fetch all tags explicitly
      - name: Fetch all tags
        run: git fetch --tags

      # 2ï¸âƒ£ Setup Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      # 3ï¸âƒ£ Install dependencies
      - name: Install dependencies
        run: npm ci

      # 4ï¸âƒ£ Check if app changed
      - name: Check if app changed
        id: check_changes
        run: |
          # Handle edge cases (first commit, shallow clone)
          if [ -z "$(git rev-parse HEAD^ 2>/dev/null)" ]; then
            echo "First commit or shallow clone - assuming changes exist"
            echo "changed=true" >> $GITHUB_OUTPUT
          elif git diff --quiet HEAD^ HEAD -- ./app; then
            echo "No changes detected in ./app"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected in ./app"
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      # 5ï¸âƒ£ Build Docker image (always for changed code)
      - name: Build Docker image
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          SHORT_SHA=${GITHUB_SHA::7}
          docker build -t $IMAGE_NAME:latest -t $IMAGE_NAME:$SHORT_SHA ./app
          echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_ENV

      # 6ï¸âƒ£ Run Trivy scan
      - name: Run Trivy scan
        if: steps.check_changes.outputs.changed == 'true'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE_NAME }}:latest
          format: table
          exit-code: 1
          severity: 'CRITICAL,HIGH'

      # 7ï¸âƒ£ Semantic Release
      - name: Semantic Release
        id: semantic
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Run semantic-release without failing workflow if no release
          npx semantic-release > release_output.txt 2>&1 || true
          cat release_output.txt

          # Detect release
          if grep -q "Published release" release_output.txt; then
            VERSION=$(grep "Published release" release_output.txt | grep -oP '\d+\.\d+\.\d+' | head -1)
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "released=true" >> $GITHUB_OUTPUT
          else
            echo "released=false" >> $GITHUB_OUTPUT
          fi

      # 8ï¸âƒ£ Build Docker image with semantic version tag (if release created)
      - name: Build Docker image with SemVer
        if: steps.semantic.outputs.released == 'true'
        run: |
          docker build \
            -t $IMAGE_NAME:latest \
            -t $IMAGE_NAME:${{ steps.semantic.outputs.version }} \
            -t $IMAGE_NAME:${GITHUB_SHA::7} ./app
          echo "SEMVER=${{ steps.semantic.outputs.version }}" >> $GITHUB_ENV

      # 9ï¸âƒ£ Login to GHCR
      - name: Log in to GHCR
        if: steps.semantic.outputs.released == 'true'
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

      # ðŸ”Ÿ Tag Docker images for GHCR
      - name: Tag Docker images
        if: steps.semantic.outputs.released == 'true'
        run: |
          REGISTRY="ghcr.io/$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')"
          docker tag $IMAGE_NAME:latest $REGISTRY/$IMAGE_NAME:latest
          docker tag $IMAGE_NAME:$SEMVER $REGISTRY/$IMAGE_NAME:$SEMVER
          docker tag $IMAGE_NAME:${GITHUB_SHA::7} $REGISTRY/$IMAGE_NAME:${GITHUB_SHA::7}

      # 1ï¸âƒ£1ï¸âƒ£ Push Docker images to GHCR
      - name: Push Docker images
        if: steps.semantic.outputs.released == 'true'
        run: |
          REGISTRY="ghcr.io/$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')"
          docker push $REGISTRY/$IMAGE_NAME:latest
          docker push $REGISTRY/$IMAGE_NAME:$SEMVER
          docker push $REGISTRY/$IMAGE_NAME:${GITHUB_SHA::7}

      # 1ï¸âƒ£2ï¸âƒ£ Workflow Summary
      - name: Workflow Summary
        if: always()
        run: |
          echo "## CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Event:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "**Triggered by:** ${{ github.event.workflow_run.name }}" >> $GITHUB_STEP_SUMMARY
            echo "**Conclusion:** ${{ github.event.workflow_run.conclusion }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_changes.outputs.changed }}" == "false" ]; then
            echo " No changes in ./app - skipped Docker build and scan." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.semantic.outputs.released }}" == "true" ]; then
            echo " Semantic Release created version: **${{ steps.semantic.outputs.version }}**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo " Docker images pushed to GHCR:" >> $GITHUB_STEP_SUMMARY
            REGISTRY="ghcr.io/$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')"
            echo "- \`$REGISTRY/$IMAGE_NAME:latest\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`$REGISTRY/$IMAGE_NAME:${{ steps.semantic.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`$REGISTRY/$IMAGE_NAME:${GITHUB_SHA::7}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo " No release created - commit messages did not match semantic release rules." >> $GITHUB_STEP_SUMMARY
          fi