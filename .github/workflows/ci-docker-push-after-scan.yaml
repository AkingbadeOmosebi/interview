name: Push Image to GHCR

on:
  workflow_run:
    workflows: ["Build and Scan with Trivy"]
    types: [completed]
# I want it to only push after the build and scan condition has been met or is successful,
# to prevent vulnerable images from being pushed to my private registry.

jobs:
  push:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    # This ensures the workflow only runs if the Trivy scan was successful.

    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write 
      # Required to push to GHCR

    env:
      REGISTRY: ghcr.io/${{ github.repository_owner }}
      IMAGE_NAME: interview-app
      SHORT_SHA: ${{ github.sha }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GHCR
        # Using my already crafted personal access token stored as GHCR_PAT secret
        run: echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Push image to GHCR
        run: |
          SHORT_SHA=$(echo "${GITHUB_SHA}" | cut -c1-7)
          docker tag $IMAGE_NAME:latest $REGISTRY/$IMAGE_NAME:latest
          docker tag $IMAGE_NAME:$SHORT_SHA $REGISTRY/$IMAGE_NAME:$SHORT_SHA
          docker push $REGISTRY/$IMAGE_NAME:latest
          docker push $REGISTRY/$IMAGE_NAME:$SHORT_SHA
