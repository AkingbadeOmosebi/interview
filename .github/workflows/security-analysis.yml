# Security Analysis Hub - All security scanning in one place
# Runs SonarCloud (SAST) and Snyk (SCA + SAST) in parallel for efficiency
# Triggered after quality-checks workflow completes successfully
name: security-analysis

on:
  workflow_run:
    workflows: ["quality-checks"]
    types: [completed]
    branches: [main]

permissions:
  contents: read

jobs:
  # Job 1: SonarCloud SAST - Static Application Security Testing
  sonarcloud:
    name: SonarCloud SAST
    runs-on: ubuntu-latest
    # This should depend on the success signal of the quality-checks workflow
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # full history helps Sonar compute metrics
          ref: ${{ github.event.workflow_run.head_sha }}

      # If your sonar-project.properties is at the repo root,
      # the action will pick it up automatically.
      - name: Run Sonar (SonarCloud / SonarQube)
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          # Optional: if you use SonarQube self-hosted, but for SonarCloud, we set SONAR_HOST_URL
          SONAR_HOST_URL: https://sonarcloud.io

  # Job 2: Snyk SCA + SAST (runs in parallel with SonarCloud)
  snyk:
    name: Snyk SCA + Code SAST
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      # Checkout your code for scanning
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      # Set up Node.js (adjust version as needed)
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '16'
          cache: 'npm'

      # Install dependencies - Snyk needs this to analyze your project
      - name: Install dependencies
        run: npm ci

      # Install Snyk CLI globally
      - name: Install Snyk CLI
        run: npm install -g snyk

      # Run Snyk vulnerability test
      - name: Run Snyk open-source vulnerability test (SCA)
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test
          args: --org=${{ secrets.SNYK_ORG_ID }} --severity-threshold=critical
        continue-on-error: true

      # Upload the scan results to Snyk platform
      - name: Monitor project snapshot on Snyk dashboard
        run: |
          snyk monitor \
            --org=${{ secrets.SNYK_ORG_ID }} \
            --project-name="${{ github.repository }}" \
            --remote-repo-url=https://github.com/${{ github.repository }} \
            --target-reference=${{ github.ref_name }}
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        continue-on-error: true

      # Run Snyk Code static analysis (SAST)
      - name: Run Snyk Code scan (SAST)
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: code test
          args: --org=${{ secrets.SNYK_ORG_ID }} --severity-threshold=high
        continue-on-error: true

      - name: Security Analysis Summary
        if: always()
        run: |
          echo "## Security Analysis Complete" >> $GITHUB_STEP_SUMMARY
          echo " Snyk SCA (dependency scan) completed" >> $GITHUB_STEP_SUMMARY
          echo " Snyk Code (SAST) completed" >> $GITHUB_STEP_SUMMARY
          echo " Check Snyk dashboard for detailed results" >> $GITHUB_STEP_SUMMARY