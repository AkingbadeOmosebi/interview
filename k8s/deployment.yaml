# Implemented Snyk Vulnerability Recommendations!

apiVersion: apps/v1
kind: Deployment      # Manifest definition type.
metadata:
  name: interview-app
  namespace: default
spec:
  replicas: 2     # How many instances or replicas of the app i want running at all times minimum
  strategy:       # How i want to define my update strategy
    type: RollingUpdate     # I chose RollingUpdate, over blue-green or canary for this very proj, 
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  selector:
    matchLabels:
      app: interview-app
  template:
    metadata:
      labels:
        app: interview-app
    spec:
      securityContext:
        runAsNonRoot: true      # Ensures container runs as non-root user
        runAsUser: 101          # Match the nginx user from Dockerfile
        fsGroup: 101            # Set filesystem group to match
      containers:
        - name: interview-app         # Name of my container
          image: ghcr.io/akingbadeomosebi/interview-app:latest     # Updated to work with new SemVer; ArgoCD Image Updater will replace this with the newest 1.0.x patch automatically
          ports:
            - containerPort: 8080     # Changed from 80 to 8080 (non-privileged port)
          imagePullPolicy: Always
          securityContext:
            allowPrivilegeEscalation: false     # Prevents privilege escalation
            capabilities:
              drop:
                - ALL                           # Drop all capabilities (no NET_BIND_SERVICE needed!)
          livenessProbe:            # Checks if container is alive and healthy
            httpGet:
              path: /               # Adjust this to your app's health endpoint (e.g., /health)
              port: 8080            # Changed from 80 to 8080
            initialDelaySeconds: 30 # Wait 30s before first check
            periodSeconds: 10       # Check every 10 seconds
            timeoutSeconds: 5       # Timeout after 5 seconds
            failureThreshold: 3     # Restart after 3 failed checks
          readinessProbe:           # Checks if container is ready to accept traffic
            httpGet:
              path: /               # Adjusted for my apps readiness endpoint
              port: 8080            # Changed from 80 to 8080
            initialDelaySeconds: 10 # Start checking after 10s
            periodSeconds: 5        # Check every 5 seconds
            timeoutSeconds: 3       # Timeout after 3 seconds
            failureThreshold: 3     # Mark unready after 3 failed checks
          resources:      # Limiting memory consumption in my cluster, so it doesnt hoard memory.
            requests:         # Limit for app
              cpu: "100m"
              memory: "128Mi"
            limits:             # Limit for cluster
              cpu: "500m"
              memory: "512Mi"