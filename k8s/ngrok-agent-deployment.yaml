apiVersion: apps/v1
kind: Deployment
metadata:
  name: ngrok-agent
  namespace: ngrok-operator
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ngrok-agent
  template:
    metadata:
      labels:
        app: ngrok-agent
    spec:
      securityContext:
        runAsNonRoot: true      # Ensures container runs as non-root user
        runAsUser: 1000         # Non-root user ID
        fsGroup: 1000            # Filesystem group for temp files/logs
      containers:
        - name: ngrok-agent
          image: ngrok/ngrok:3
          args:
            - "http"
            - "interview-app.default.svc.cluster.local:8080"   # Target my app service (now matches pod port for cleaner architecture)
            - "--authtoken"
            - "$(NGROK_AUTH_TOKEN)"
            - "--log"
            - "stdout"
          env:
            - name: NGROK_AUTH_TOKEN
              valueFrom:
                secretKeyRef:
                  name: ngrok-secret
                  key: authtoken
          ports:
            - containerPort: 4040   # Ngrok Web UI for external access to ngrok status
          securityContext:
            allowPrivilegeEscalation: false     # Prevent privilege escalation
            capabilities:
              drop:
                - ALL                           # Drop all capabilities for extra security
          livenessProbe:            # Checks if ngrok agent is alive
            httpGet:
              path: /status         # Ngrok web UI status endpoint
              port: 4040
            initialDelaySeconds: 30 # Wait 30s before first check
            periodSeconds: 10       # Check every 10 seconds
            timeoutSeconds: 5       # Timeout after 5 seconds
            failureThreshold: 3     # Restart after 3 failed checks
          readinessProbe:           # Checks if ngrok is ready to proxy traffic
            httpGet:
              path: /status         # Ngrok web UI status endpoint
              port: 4040
            initialDelaySeconds: 10 # Start checking after 10s
            periodSeconds: 5        # Check every 5 seconds
            timeoutSeconds: 3       # Timeout after 3 seconds
            failureThreshold: 3     # Mark unready after 3 failed checks
          resources:                # Resource limits for ngrok agent
            requests:
              cpu: "50m"            # Ngrok is lightweight
              memory: "64Mi"
            limits:
              cpu: "200m"
              memory: "256Mi"
